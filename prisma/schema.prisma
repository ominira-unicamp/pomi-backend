generator client {
  provider            = "prisma-client"
  output              = "./generated"
  moduleFormat        = "esm"
  importFileExtension = "js"
}

generator zod {
  provider = "prisma-zod-generator"
  output   = "./generated/zod"
  config   = "./config-zod.json"
}

generator dbml {
  provider = "prisma-dbml-generator"
}

datasource db {
  provider = "postgresql"
}

enum YearPeriods {
  SUMMER
  FIRST_SEMESTER
  WINTER
  SECOND_SEMESTER
}

model User {
  id    Int    @id @default(autoincrement())
  email String @unique
  name  String
}

// ----------------------- Academic Models ----------------------- //

model Institute {
  id       Int        @id @default(autoincrement())
  code     String     @unique
  courses  Course[]
  prefixes Prefixes[]
  programs Program[]
}

model Prefixes {
  id          Int       @id @default(autoincrement())
  prefix      String     @unique
  institute   Institute @relation(fields: [instituteId], references: [id])
  instituteId Int

  courseRequirements CourseRequirement[]
  courses            Course[]
}

model Course {
  id          Int       @id @default(autoincrement())
  code        String    @unique
  name        String
  credits     Int
  institute   Institute @relation(fields: [instituteId], references: [id])
  instituteId Int
  prefix      Prefixes? @relation(fields: [prefixId], references: [id])
  prefixId    Int?

  classes            Class[]
  studentCourses     StudentCourse[]
  curriculumCourses  CurriculumCourse[]
  courseRequirements CourseRequirement[]
}

// ----------------------- Programs Catalog Models ----------------------- //

model Catalog {
  id       Int              @id @default(autoincrement())
  year     Int
  programs CatalogProgram[]

  students Student[]
}

model Program {
  id              Int              @id @default(autoincrement())
  code            Int              @unique
  name            String
  institute       Institute        @relation(fields: [instituteId], references: [id])
  instituteId     Int
  catalogPrograms CatalogProgram[]
  students        Student[]
}

model Specialization {
  id       Int       @id @default(autoincrement())
  code     String
  name     String
  students Student[]

  catalogSpecializations CatalogSpecialization[]
}

model Language {
  id   Int    @id @default(autoincrement())
  name String
  catalogLanguages CatalogLanguage[]
}

model CatalogProgram {
  id        Int     @id @default(autoincrement())
  catalog   Catalog @relation(fields: [catalogId], references: [id])
  catalogId Int
  program   Program @relation(fields: [programId], references: [id])
  programId Int
  catalogSpecializations CatalogSpecialization[]
  catalogLanguages CatalogLanguage[]
  @@unique([catalogId, programId])
  courseBlocks CourseBlock[]
}

model CatalogSpecialization {
  id               Int            @id @default(autoincrement())
  catalogProgram   CatalogProgram @relation(fields: [catalogProgramId], references: [id], onDelete: Cascade)
  catalogProgramId Int
  specialization   Specialization @relation(fields: [specializationId], references: [id], onDelete: Cascade)
  specializationId Int

  courseBlocks CourseBlock[]
  @@unique([catalogProgramId, specializationId])
}

model CatalogLanguage {
  id               Int            @id @default(autoincrement())
  catalogProgram   CatalogProgram @relation(fields: [catalogProgramId], references: [id], onDelete: Cascade)
  catalogProgramId Int
  language         Language       @relation(fields: [languageId], references: [id], onDelete: Cascade)
  languageId       Int
  courseBlocks CourseBlock[]
  @@unique([catalogProgramId, languageId])
}

// ----------------------- Course Requirements Models ----------------------- //

enum CourseBlockType {
  mandatory
  elective
}

enum CourseRequirementType {
  any
  prefix
  specific
}

model CourseBlock {
  id                      Int                    @id @default(autoincrement())
  type                    CourseBlockType
  credits                 Int?
  
  catalogLanguage         CatalogLanguage?       @relation(fields: [catalogLanguageId], references: [id], onDelete: Cascade)
  catalogLanguageId       Int?
  
  catalogSpecialization   CatalogSpecialization? @relation(fields: [catalogSpecializationId], references: [id], onDelete: Cascade)
  catalogSpecializationId Int?
  
  catalogProgram          CatalogProgram?        @relation(fields: [catalogProgramId], references: [id], onDelete: Cascade)
  catalogProgramId        Int?

  courseRequirements CourseRequirement[]
}

model CourseRequirement {
  id            Int                   @id @default(autoincrement())
  courseBlock   CourseBlock           @relation(fields: [courseBlockId], references: [id], onDelete: Cascade)
  courseBlockId Int
  type          CourseRequirementType
  course        Course?               @relation(fields: [courseId], references: [id])
  courseId      Int?
  prefix        Prefixes?             @relation(fields: [prefixId], references: [id])
  prefixId      Int?
}

// ----------------------- Timetable Booklet Models ----------------------- //

model StudyPeriod {
  id              Int              @id @default(autoincrement())
  code            String           @unique
  startDate       DateTime
  classes         Class[]
  periodPlannings PeriodPlanning[]
}

model Professor {
  id      Int     @id @default(autoincrement())
  name    String
  classes Class[]
}

model Room {
  id             Int             @id @default(autoincrement())
  code           String          @unique
  classSchedules ClassSchedule[]
}

model Class {
  id            Int         @id @default(autoincrement())
  code          String
  studyPeriod   StudyPeriod @relation(fields: [studyPeriodId], references: [id])
  studyPeriodId Int
  course        Course      @relation(fields: [courseId], references: [id])
  courseId      Int
  reservations  Int[]

  professors      Professor[]
  classSchedules  ClassSchedule[]
  periodPlannings PeriodPlanning[]
}

//  Sim é um Enum para dias das semanas, não é melhor coisa, mas quis assim. 
enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model ClassSchedule {
  id        Int       @id @default(autoincrement())
  dayOfWeek DayOfWeek
  start     String
  end       String
  room      Room      @relation(fields: [roomId], references: [id])
  roomId    Int
  class     Class     @relation(fields: [classId], references: [id])
  classId   Int
}

// ----------------------- Student Models ----------------------- //

enum StudentCourseStatus {
  ENROLLED
  COMPLETED
  DROPPED
}

model Student {
  id               Int             @id @default(autoincrement())
  ra               String          @unique
  name             String
  program          Program?        @relation(fields: [programId], references: [id])
  programId        Int?
  specialization   Specialization? @relation(fields: [specializationId], references: [id])
  specializationId Int?
  catalog          Catalog?        @relation(fields: [catalogId], references: [id])
  catalogId        Int?

  courses         StudentCourse[]
  periodPlannings PeriodPlanning[]
  curriculums     Curriculum[]
}

model StudentCourse {
  student   Student             @relation(fields: [studentId], references: [id])
  studentId Int
  course    Course              @relation(fields: [courseId], references: [id])
  courseId  Int
  status    StudentCourseStatus

  @@id([studentId, courseId])
}

model Curriculum {
  id                Int                @id @default(autoincrement())
  student           Student            @relation(fields: [studentId], references: [id])
  studentId         Int
  CurriculumCourses CurriculumCourse[]
}

model CurriculumCourse {
  curriculum   Curriculum @relation(fields: [curriculumId], references: [id])
  curriculumId Int
  course       Course     @relation(fields: [courseId], references: [id])
  courseId     Int
  semester     Int?

  @@id([curriculumId, courseId])
}

model PeriodPlanning {
  id            Int         @id @default(autoincrement())
  studyPeriod   StudyPeriod @relation(fields: [studyPeriodId], references: [id])
  studyPeriodId Int
  student       Student     @relation(fields: [studentId], references: [id])
  studentId     Int

  classes Class[]
}
